<!DOCTYPE html>
<html lang="es">
<head>
 <style>
  html,
  body { 
            width: 100% !important;
            height: 100% !important;
            margin: 0;
            padding: 0;
             font-family: Arial, sans-serif;
            background: linear-gradient(135deg,  0%,  100%);
            color: white;
            overflow: hidden;
        }
 :root {
  --dark-color: #001202;
  --mid-dark: #051F20;
  --light-color: #051F20;
  --mid-light: #051F20;
  --shadow: #051F20;
  --linear-rainbow: linear-gradient(
    to right,
    #163832,
    #163832,
    #163832,
    #163832,
    #163832
  );
  --circle-rainbow: radial-gradient(
    circle at left top,
    #051F20,
    #051F20,
   #051F20,
    #051F20,
   #051F20
  );
  --noise-texture: url(https://i.imgur.com/i0T9edr.png);
  --gif-texture: url();
  --mulish: "Mulish", sans-serif;
  --playfair: "Playfair Display", serif;
  --dm: "DM Serif Display", serif;
  --main-transition: all 0.2s ease-in-out;
}

html,
body {
  margin: 0;
}

body {

  background-color: #01261F	;
  background-image: var(--noise-texture);
  background-blend-mode: overlay;
}
       /* Estilos para mensajes */
        .message-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg,  0%, 100%);
            z-index: 1000;
        }

        .message-box {
            background: #333;
            border: 2px solid  gold;
            border-radius: 20px;
            padding: 40px;
            max-height: 300px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-icon {
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--color-primary);
        }

        .message-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color:#FFFFFF;
        }

        .message-text {
            font-size: 1.1rem;
            line-height: 1.2;
            margin-bottom: 30px;
            color: #FFFFFF;
        }

 .install-button {
            background:  #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.0rem;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: #fff;
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px #fff;
        }

        .retry-button {
             background:  #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.0rem;
            font-weight: bold;
            cursor: pointer;
            margin-left: 15px;
            transition: all 0.3s ease;
        }

        .retry-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px #fff;
        }
      .loading-spinner {
  animation: rotate 1s infinite;  
  height: 50px;
  width: 50px;
}

.loading-spinner:before,
.loading-spinner:after {   
  border-radius: 50%;
  content: '';
  display: block;
  height: 20px;  
  width: 20px;
}
.loading-spinner:before {
  animation: ball1 1s infinite;  
  background-color: #cb2025;
  box-shadow: 30px 0 0 #f8b334;
  margin-bottom: 10px;
}
.loading-spinner:after {
  animation: ball2 1s infinite; 
  background-color: #00a096;
  box-shadow: 30px 0 0 #97bf0d;
}

@keyframes rotate {
  0% { 
    -webkit-transform: rotate(0deg) scale(0.8); 
    -moz-transform: rotate(0deg) scale(0.8);
  }
  50% { 
    -webkit-transform: rotate(360deg) scale(1.2); 
    -moz-transform: rotate(360deg) scale(1.2);
  }
  100% { 
    -webkit-transform: rotate(720deg) scale(0.8); 
    -moz-transform: rotate(720deg) scale(0.8);
  }
}

@keyframes ball1 {
  0% {
    box-shadow: 30px 0 0 #f8b334;
  }
  50% {
    box-shadow: 0 0 0 #f8b334;
    margin-bottom: 0;
    -webkit-transform: translate(15px,15px);
    -moz-transform: translate(15px, 15px);
  }
  100% {
    box-shadow: 30px 0 0 #f8b334;
    margin-bottom: 10px;
  }
}

@keyframes ball2 {
  0% {
    box-shadow: 30px 0 0 #97bf0d;
  }
  50% {
    box-shadow: 0 0 0 #97bf0d;
    margin-top: -20px;
    -webkit-transform: translate(15px,15px);
    -moz-transform: translate(15px, 15px);
  }
  100% {
    box-shadow: 30px 0 0 #97bf0d;
    margin-top: 0;
  }
}
      
      
      
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }
    #player {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .extension-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .error-box .message-icon {
            color: var(--color-danger);
        }

        .error-box .message-title {
            color: var(--color-danger);
        }

        .error-box {
            border-color: var(--color-danger);
        }
    </style>

<script src="https://cantodspaexteenop1.github.io/channel-1dife.js"></script>
</head>

<body>
     <!-- Mensaje de carga -->
    <div id="loading-message" class="message-container">
        <div >
          <div class="loading-spinner"></div>
            <center><div class="message-title">Cargando</div></center>
            
        </div>
    </div>

    <!-- Mensaje de extensión faltante -->
    <div id="alerta-extension" class="message-container hidden">
        <div class="message-box">
            <div class="message-icon">⚠️</div>
            <div class="message-title">Instalar Extensión VideoPlayer</div>
            <div class="message-text">
                Para ver los canales, necesitas añadir la extensión VideoPlayer.<br>
                   Es un reproductor nativo para videos.<br>

Una vez instalada la extensión en tu Navegador,<br> recargar la página.
                <br>
               Recuerda:La Opción FL estan disponibles en Argentina,Paraguay,Uruguay,<br>
             sino estas en estos paises usar VPN conectado estos Paises
            </div>
            <a href="https://chromewebstore.google.com/detail/videoplayer-mpdm3u8m3uepg/opmeopcambhfimffbomjgemehjkbbmji"
                class="install-button" target="_blank">
                Instalar Extensión
            </a>
            <button class="retry-button" onclick="initializePlayer()">
                Recargar
            </button>
        </div>
    </div>

    <!-- Reproductor -->
    <div id="player" class="hidden"></div>

    <script>
        const STREAM_URL = "chrome-extension://opmeopcambhfimffbomjgemehjkbbmji/pages/player.html#https://localhost/?headers=eyJPcmlnaW4iOiAiaHR0cHM6Ly9wb3J0YWwuYXBwLmZsb3cuY29tLmFyIiwgIlJlZmVyZXIiOiJodHRwczovL3BvcnRhbC5hcHAuZmxvdy5jb20uYXIifQ==";

        let currentChannel;
        let mpdBase;
        let iframeAdded = false;

        // Función para mostrar/ocultar elementos
        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function hideAllMessages() {
            hideElement('loading-message');
            hideElement('alerta-extension');
        }

        // Función para obtener parámetros de URL
        function getParameterByName(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Función para verificar si la extensión está instalada
        function isExtensionInstalled(installedCallback, notInstalledCallback) {
            const img = document.createElement('img');
            img.onload = installedCallback;
            img.onerror = notInstalledCallback;
            img.src = 'chrome-extension://opmeopcambhfimffbomjgemehjkbbmji/play-on.png';
        }

            // Función para agregar el iframe al reproductor cuando hay error
        function addIframeToPlayer() {
            if (!iframeAdded) {
                console.log("Agregando iframe de respaldo al reproductor...");

                const playerDiv = document.getElementById('player');

                // Limpiar contenido previo del reproductor
                playerDiv.innerHTML = '';

                // Crear y agregar iframe
                const iframe = document.createElement('iframe');
                iframe.className = 'extension-iframe';
                iframe.src = STREAM_URL;
                iframe.allow = 'encrypted-media *;';
                iframe.frameBorder = '0';
                playerDiv.appendChild(iframe);

                iframeAdded = true;

                // Mostrar el reproductor
                hideAllMessages();
                showElement('player');
            }
        }
     
        // Función para cargar el canal después del reinicio
        async function loadChannelStream() {
            try {
                console.log("Cargando canal después del reinicio...");

                // Verificar si channelList existe
                if (typeof channelList === 'undefined' || typeof getChannelKeys === 'undefined') {
                    throw new Error('Los archivos de canales no se cargaron correctamente');
                }

                const channels = getChannelKeys(getParameterByName('get'));
                if (!channels || channels.length === 0) {
                    throw new Error('No se encontraron canales válidos');
                }

                currentChannel = channels[0];
                console.log("Canal seleccionado:", currentChannel);

                // Verificar keyId y key
                const keyId = currentChannel.keyId;
                const key = currentChannel.key;

                if (!keyId || !key) {
                    throw new Error('KeyId o Key no definidos en el canal seleccionado');
                }

                // Obtener MPD base
                if (typeof getValidMpd !== 'undefined') {
                    mpdBase = await getValidMpd();
                } else {
                    throw new Error('Función getValidMpd no disponible');
                }

                if (!mpdBase) {
                    throw new Error('No se pudo obtener una URL de stream válida');
                }

                console.log("MPD obtenido:", mpdBase);

                // Convertir keyId y key a una cadena JSON
                var keyString = `"${keyId}":"${key}"`;
                var base64Key = btoa(keyString);

                console.log("KeyString:", keyString);
                console.log("Base64Key:", base64Key);

                // Construir la URL de la extensión con el header específico
                var extensionUrl = `chrome-extension://opmeopcambhfimffbomjgemehjkbbmji/pages/player.html#${mpdBase}?ck=${encodeURIComponent(base64Key)}&headers=eyJPcmlnaW4iOiAiaHR0cHM6Ly9wb3J0YWwuYXBwLmZsb3cuY29tLmFyIiwgIlJlZmVyZXIiOiJodHRwczovL3BvcnRhbC5hcHAuZmxvdy5jb20uYXIifQ==`;

                console.log("Extension URL:", extensionUrl);

                // Mostrar el reproductor
                const playerDiv = document.getElementById("player");

                isExtensionInstalled(
                    () => {
                        console.log("Extensión detectada, cargando canal...");
                        hideAllMessages();
                        playerDiv.classList.remove("hidden");
                        playerDiv.innerHTML = `<iframe id="iframe" class="extension-iframe" allow="encrypted-media" allowfullscreen src="${extensionUrl}"></iframe>`;
                    },
                    () => {
                        console.log("Extensión no detectada después del reinicio");
                        hideAllMessages();
                        document.getElementById("alerta-extension").classList.remove("hidden");
                    }
                );

            } catch (error) {
                console.error("Error cargando canal:", error);
                hideAllMessages();
                alert(`Error: ${error.message}`);
            }
        }

        // Función principal de inicialización
        function initializePlayer() {
            console.log("Inicializando reproductor...");

            // Verificar si es la segunda carga (después del reload)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('reloaded') === 'true') {
                console.log("Segunda carga detectada, cargando canal...");
                loadChannelStream();
                return;
            }

            // Primera carga - verificar extensión y iniciar servidor
            isExtensionInstalled(
                () => {
                    console.log("Extensión detectada, iniciando servidor...");
                    // Marcar que vamos a recargar
                    const newUrl = window.location.href + (window.location.search ? '&' : '?') + 'reloaded=true';
                    history.replaceState(null, '', newUrl);
                    addIframeToPlayer();
                },
                () => {
                    console.log("Extensión no detectada");
                    hideAllMessages();
                    document.getElementById("alerta-extension").classList.remove("hidden");
                }
            );
        }

        // Inicializar cuando la página esté lista
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Página cargada, inicializando...");

            // Pequeño delay para asegurar que todos los scripts se carguen
            setTimeout(() => {
                initializePlayer();
            }, 100);
        });

        // Manejo de errores globales
        window.addEventListener('error', function (e) {
            console.error('Error global:', e.error);
        });
    </script>
</body>

</html>
