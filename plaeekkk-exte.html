<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>-</title>
<style>
 body {
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        .container {
            width: 100%;
            height: 100vh;
             position: fixed;
             display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        #player {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .extension-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: black;
        }

        .hidden {
            display: none;
        }

.alert-card {
    background-color: #333;
    border-radius: 8px;
    padding: 20px;
    max-width: 600px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    margin: 20px auto;
}

.alert-card h2 {
    margin-top: 0;
    font-size: 24px;
}

.alert-card .boxicon {
    font-size: 48px;
    color: #ff0;
}

.alert-card p {
    margin: 10px 0;
    color: #ebebeb;
}

@media (max-width: 480px) {
    .alert-card {
        max-width: 90%;
        padding: 5px;
        margin-right: 50px;
    }

    .alert-card h2 {
        font-size: 20px;
    }

    .alert-card .boxicon {
        font-size: 36px;
    }

    .alert-card p {
        font-size: 14px;
    }
}

@media (min-width: 481px) and (max-width: 768px) {
    .alert-card {
        max-width: 80%;
        padding: 25px;
    }

    .alert-card h2 {
        font-size: 22px;
    }

    .alert-card .boxicon {
        font-size: 42px;
    }

    .alert-card p {
        font-size: 16px; 
    }
}
 a {
                        color: #ff0 ;
                        text-decoration: underline;
                }



        .retry-button {
            background:#0f0;
            color: #000;
            border: 2px solid ;
            padding: 10px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-left: 15px;
            transition: all 0.3s ease;
        }

        .retry-button:hover {
            background: #fff;
            color: #000;
          transform: translateY(-2px);
            box-shadow: 0 8px 30px #fff;
        }
    </style>
    <script src="kkk.js"></script>

</head>

<body>
    <!-- Mensaje de carga -->
    <div id="loading-message" class="message-container">
        <div class="message-box">
            <div class="loading-spinner"></div>
            <div class="message-title"></div>
            <div class="message-text"></div>
        </div>
    </div>

    <!-- Mensaje de extensi贸n faltante -->
   
 <div class="container">
        <div id="alerta-extension" class="hidden alert-card text-center bg-dark bg-gradient">
            <i class="bx bx-error-circle boxicon"></i>
            <h2>Instalar Extensi贸n VideoPlayer</h2>
            <p>Para ver los canales, necesitas a帽adir la extensi贸n VideoPlayer</p>
            <p>Es un reproductor nativo para videos.</p>
            <p>Una vez instalada la extensi贸n en tu Navegador, recargar esta p谩gina.</p>
            <p>Recuerda: estos canales estan disponibles en Argentina, Paraguay, Uruguay o con VPN de estos
                Paises.</p>
            <!-- <p>Una vez instalada la extensi贸n, recarga la p谩gina.</p> -->
            <a class="btn retry-button"
                href="https://chromewebstore.google.com/detail/reproductor-mpdm3u8m3uepg/opmeopcambhfimffbomjgemehjkbbmji"
                target="_blank">Instalar ahora</a>
        </div>
    </div>

          

    <!-- Reproductor -->
    <div id="player" class="hidden"></div>

    <script>
        const STREAM_URL = "chrome-extension://opmeopcambhfimffbomjgemehjkbbmji/pages/player.html#https://localhost/?headers=eyJPcmlnaW4iOiAiaHR0cHM6Ly9wb3J0YWwuYXBwLmZsb3cuY29tLmFyIiwgIlJlZmVyZXIiOiJodHRwczovL3BvcnRhbC5hcHAuZmxvdy5jb20uYXIifQ==";

        let currentChannel;
        let mpdBase;
        let iframeAdded = false;

        // Funci贸n para mostrar/ocultar elementos
        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function hideAllMessages() {
            hideElement('loading-message');
            hideElement('alerta-extension');
        }

        // Funci贸n para obtener par谩metros de URL
        function getParameterByName(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Funci贸n para verificar si la extensi贸n est谩 instalada
        function isExtensionInstalled(installedCallback, notInstalledCallback) {
            const img = document.createElement('img');
            img.onload = installedCallback;
            img.onerror = notInstalledCallback;
            img.src = 'chrome-extension://opmeopcambhfimffbomjgemehjkbbmji/play-on.png';
        }

        // Funci贸n para agregar el iframe al reproductor cuando hay error
        function addIframeToPlayer() {
            if (!iframeAdded) {
                console.log("Agregando iframe de respaldo al reproductor...");

                const playerDiv = document.getElementById('player');

                // Limpiar contenido previo del reproductor
                playerDiv.innerHTML = '';

                // Crear y agregar iframe
                const iframe = document.createElement('iframe');
                iframe.className = 'extension-iframe';
                iframe.src = STREAM_URL;
                iframe.allow = 'encrypted-media *;';
                iframe.frameBorder = '0';

                //  lo ocultamos
                iframe.style.display = "none";

                //  Espera 1 segundo cuando cargue el iframe y reinicia la p谩gina
                iframe.onload = () => {
                    console.log("Iframe cargado, reiniciando en 1 segundo...");
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                };

                playerDiv.appendChild(iframe);

                iframeAdded = true;

                // Mostrar el reproductor
                hideAllMessages();
                showElement('player');
            }
        }

        // Funci贸n para cargar el canal despu茅s del reinicio
        async function loadChannelStream() {
            try {
                console.log("Cargando canal despu茅s del reinicio...");

                // Verificar si channelList existe
                if (typeof channelList === 'undefined' || typeof getChannelKeys === 'undefined') {
                    throw new Error('Los archivos de canales no se cargaron correctamente');
                }

                const channels = getChannelKeys(getParameterByName('get'));
                if (!channels || channels.length === 0) {
                    throw new Error('No se encontraron canales v谩lidos');
                }

                currentChannel = channels[0];
                console.log("Canal seleccionado:", currentChannel);

                // Verificar keyId y key
                const keyId = currentChannel.keyId;
                const key = currentChannel.key;

                if (!keyId || !key) {
                    throw new Error('KeyId o Key no definidos en el canal seleccionado');
                }

                // Obtener MPD base
                if (typeof getValidMpd !== 'undefined') {
                    mpdBase = await getValidMpd();
                } else {
                    throw new Error('Funci贸n getValidMpd no disponible');
                }

                if (!mpdBase) {
                    throw new Error('No se pudo obtener una URL de stream v谩lida');
                }

                console.log("MPD obtenido:", mpdBase);

                // Convertir keyId y key a una cadena JSON
                var keyString = `"${keyId}":"${key}"`;
                var base64Key = btoa(keyString);

                console.log("KeyString:", keyString);
                console.log("Base64Key:", base64Key);

                // Construir la URL de la extensi贸n con el header espec铆fico
                var extensionUrl = `chrome-extension://opmeopcambhfimffbomjgemehjkbbmji/pages/player.html#${mpdBase}?ck=${encodeURIComponent(base64Key)}&headers=eyJPcmlnaW4iOiAiaHR0cHM6Ly9wb3J0YWwuYXBwLmZsb3cuY29tLmFyIiwgIlJlZmVyZXIiOiJodHRwczovL3BvcnRhbC5hcHAuZmxvdy5jb20uYXIifQ==`;

                console.log("Extension URL:", extensionUrl);

                // Mostrar el reproductor
                const playerDiv = document.getElementById("player");

                isExtensionInstalled(
                    () => {
                        console.log("Extensi贸n detectada, cargando canal...");
                        hideAllMessages();
                        playerDiv.classList.remove("hidden");
                        playerDiv.innerHTML = `<iframe id="iframe" class="extension-iframe" allow="encrypted-media" allowfullscreen src="${extensionUrl}"></iframe>`;
                    },
                    () => {
                        console.log("Extensi贸n no detectada despu茅s del reinicio");
                        hideAllMessages();
                        document.getElementById("alerta-extension").classList.remove("hidden");
                    }
                );

            } catch (error) {
                console.error("Error cargando canal:", error);
                hideAllMessages();
                alert(`Error: ${error.message}`);
            }
        }

        // Funci贸n principal de inicializaci贸n
        function initializePlayer() {
            console.log("Inicializando reproductor...");

            // Verificar si es la segunda carga (despu茅s del reload)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('reloaded') === 'true') {
                console.log("Segunda carga detectada, cargando canal...");
                loadChannelStream();
                return;
            }

            // Primera carga - verificar extensi贸n y iniciar servidor
            isExtensionInstalled(
                () => {
                    console.log("Extensi贸n detectada, iniciando servidor...");
                    // Marcar que vamos a recargar
                    const newUrl = window.location.href + (window.location.search ? '&' : '?') + 'reloaded=true';
                    history.replaceState(null, '', newUrl);
                    addIframeToPlayer();
                },
                () => {
                    console.log("Extensi贸n no detectada");
                    hideAllMessages();
                    document.getElementById("alerta-extension").classList.remove("hidden");
                }
            );
        }

        // Inicializar cuando la p谩gina est茅 lista
        document.addEventListener('DOMContentLoaded', function () {
            console.log("P谩gina cargada, inicializando...");

            // Peque帽o delay para asegurar que todos los scripts se carguen
            setTimeout(() => {
                initializePlayer();
            }, 100);
        });

        // Manejo de errores globales
        window.addEventListener('error', function (e) {
            console.error('Error global:', e.error);
        });
    </script>
</body>

</html>
